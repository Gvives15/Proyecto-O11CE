{# frontend/templates/usuarios/usuarios_form.html #}
{% extends 'base.html' %}

{% block title %}
  {% if usuario_id %}Editar Usuario{% else %}Crear Usuario{% endif %}
{% endblock %}

{% block content %}
  <div class="container" style="max-width: 600px; margin-top: 20px;">
    <h1>{% if usuario_id %}Editar Usuario{% else %}Crear Usuario{% endif %}</h1>
    <form id="usuario-form">
      {% csrf_token %}
      <div class="form-group">
        <label for="username">Nombre de Usuario</label>
        <input type="text" id="username" name="username" class="form-control" required>
        <small id="error-username" class="text-danger"></small>
      </div>

      <div class="form-group">
        <label for="email">Correo Electrónico</label>
        <input type="email" id="email" name="email" class="form-control" required>
        <small id="error-email" class="text-danger"></small>
      </div>

      <div class="form-group">
        <label for="first_name">Nombre</label>
        <input type="text" id="first_name" name="first_name" class="form-control">
        <small id="error-first_name" class="text-danger"></small>
      </div>

      <div class="form-group">
        <label for="last_name">Apellido</label>
        <input type="text" id="last_name" name="last_name" class="form-control">
        <small id="error-last_name" class="text-danger"></small>
      </div>

      <div class="form-group">
        <label for="rol">Rol</label>
        <select id="rol" name="rol" class="form-control" required>
          <option value="">-- Selecciona un rol --</option>
          {% for r in roles %}
            <option value="{{ r.id }}">{{ r.nombre }}</option>
          {% endfor %}
        </select>
        <small id="error-rol" class="text-danger"></small>
      </div>

      <button type="submit" class="btn btn-primary">
        {% if usuario_id %}Actualizar{% else %}Crear{% endif %}
      </button>
      <button type="button" class="btn btn-secondary" id="btn-cancelar">Cancelar</button>
    </form>
  </div>
{% endblock %}

{% block extra_js %}
<script>
  const usuarioId = {{ usuario_id|default:'null' }};

  async function cargarUsuario() {
    if (!usuarioId) return;
    const resp = await fetch(`/users/api/usuarios/${usuarioId}/`, {
      method: 'GET',
      credentials: 'include'
    });
    if (resp.status === 401 || resp.status === 403) {
      window.location.href = '/dashboard/login-page/';
      return;
    }
    const data = await resp.json();
    document.getElementById('username').value = data.username;
    document.getElementById('email').value = data.email;
    document.getElementById('first_name').value = data.first_name;
    document.getElementById('last_name').value = data.last_name;
    document.getElementById('rol').value = data.rol; // data.rol es el ID del rol
  }

  async function enviarForm(event) {
    event.preventDefault();

    // Limpiar mensajes de error
    document.getElementById('error-username').textContent = '';
    document.getElementById('error-email').textContent = '';
    document.getElementById('error-first_name').textContent = '';
    document.getElementById('error-last_name').textContent = '';
    document.getElementById('error-rol').textContent = '';

    const payload = {
      username: document.getElementById('username').value,
      email: document.getElementById('email').value,
      first_name: document.getElementById('first_name').value,
      last_name: document.getElementById('last_name').value,
      rol: parseInt(document.getElementById('rol').value)
    };

    let url = '/users/api/usuarios/';
    let method = 'POST';
    if (usuarioId) {
      url = `/users/api/usuarios/${usuarioId}/`;
      method = 'PUT';
    }

    const resp = await fetch(url, {
      method: method,
      credentials: 'include',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    if (resp.status === 201 || resp.status === 200) {
      window.location.href = '/dashboard/usuarios/';
    } else if (resp.status === 400) {
      const errores = await resp.json();
      for (const campo in errores) {
        const errElem = document.getElementById(`error-${campo}`);
        if (errElem) {
          errElem.textContent = errores[campo][0];
        }
      }
    } else if (resp.status === 403) {
      alert('No tienes permiso para realizar esta acción.');
    } else {
      alert('Error inesperado.');
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    if (usuarioId) {
      cargarUsuario();
    }
    document.getElementById('usuario-form').addEventListener('submit', enviarForm);
    document.getElementById('btn-cancelar').addEventListener('click', () => {
      window.location.href = '/dashboard/usuarios/';
    });
  });
</script>
{% endblock %}
